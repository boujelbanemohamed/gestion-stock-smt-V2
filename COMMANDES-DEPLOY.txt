================================================================================
DÃ‰PLOIEMENT REDHAT - COMMANDES Ã€ COPIER-COLLER
================================================================================

âš ï¸ IMPORTANT: Votre base de donnÃ©es contient dÃ©jÃ  des donnÃ©es rÃ©elles.
   Le script prÃ©serve TOUTES vos donnÃ©es existantes.

================================================================================

Ã‰TAPE 1 : CONNEXION AU SERVEUR
-------------------------------
ssh utilisateur@adresse-serveur-redhat

# Remplacez "utilisateur" et "adresse-serveur-redhat" par vos valeurs


================================================================================

Ã‰TAPE 2 : ALLER DANS LE RÃ‰PERTOIRE
-----------------------------------
cd /chemin/vers/stock-management-V2

# Remplacez par le vrai chemin, exemple :
# cd /var/www/stock-management-V2


================================================================================

Ã‰TAPE 3 : BACKUP DE SÃ‰CURITÃ‰ (RECOMMANDÃ‰)
------------------------------------------
pg_dump -U postgres stock_management > backup_securite_$(date +%Y%m%d_%H%M%S).sql
ls -lh backup_securite_*.sql

# VÃ©rifiez que le backup est crÃ©Ã© (taille en Mo)


================================================================================

Ã‰TAPE 4 : COMPTER VOS DONNÃ‰ES ACTUELLES (RECOMMANDÃ‰)
-----------------------------------------------------
psql -U postgres stock_management -c "
SELECT 'Users' as type, COUNT(*) FROM \"User\"
UNION ALL SELECT 'Banks', COUNT(*) FROM \"Bank\"
UNION ALL SELECT 'Cards', COUNT(*) FROM \"Card\"
UNION ALL SELECT 'Movements', COUNT(*) FROM \"Movement\"
UNION ALL SELECT 'AuditLogs', COUNT(*) FROM \"AuditLog\";
"

# NOTEZ CES CHIFFRES pour comparaison aprÃ¨s dÃ©ploiement


================================================================================

Ã‰TAPE 5 : LANCER LE DÃ‰PLOIEMENT
--------------------------------
chmod +x deploy.sh
./deploy.sh

# Attendez 2-3 minutes
# Le script crÃ©e un backup automatique et dÃ©ploie


================================================================================

Ã‰TAPE 6 : VÃ‰RIFIER LE COMMIT
-----------------------------
git log --oneline -1

# Doit afficher : 144684e docs: Guides dÃ©ploiement...


================================================================================

Ã‰TAPE 7 : VÃ‰RIFIER PM2
----------------------
pm2 status

# Doit afficher "online"

pm2 logs stock-management --lines 20

# Pas d'erreurs en rouge


================================================================================

Ã‰TAPE 8 : RECOMPTER LES DONNÃ‰ES
--------------------------------
psql -U postgres stock_management -c "
SELECT 'Users' as type, COUNT(*) FROM \"User\"
UNION ALL SELECT 'Banks', COUNT(*) FROM \"Bank\"
UNION ALL SELECT 'Cards', COUNT(*) FROM \"Card\"
UNION ALL SELECT 'Movements', COUNT(*) FROM \"Movement\"
UNION ALL SELECT 'AuditLogs', COUNT(*) FROM \"AuditLog\";
"

# COMPAREZ avec Ã‰TAPE 4 : les chiffres doivent Ãªtre identiques !


================================================================================

Ã‰TAPE 9 : TEST API
------------------
curl http://localhost:3000/api/users | jq '.data | length'
curl http://localhost:3000/api/cards | jq '.data | length'
curl http://localhost:3000/api/logs?limit=5 | jq '.total'

# Les nombres doivent correspondre Ã  vos donnÃ©es


================================================================================

Ã‰TAPE 10 : TEST NAVIGATEUR
---------------------------
Ouvrir : http://votre-domaine.com

1. Se connecter
2. Menu Banques â†’ VÃ©rifier que toutes vos banques sont lÃ 
3. Menu Cartes â†’ VÃ©rifier toutes vos cartes
4. Cliquer "Ajouter une carte" :
   âœ“ Seuil max = 100000 ?
   âœ“ Placeholder Sous-type = "ex. Nationale" ?
   âœ“ Placeholder Sous-sous-type = "ex. Nom de la carte" ?
5. Menu Mouvements â†’ VÃ©rifier l'historique
6. Menu Logs â†’ VÃ©rifier les logs (30 jours)
7. IcÃ´ne ðŸ”” â†’ VÃ©rifier les notifications


================================================================================

âœ… DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS !
================================================================================

Vos donnÃ©es sont prÃ©servÃ©es et les nouvelles fonctionnalitÃ©s sont actives :
  âœ“ Logs d'audit : Filtre 30 jours
  âœ“ Notifications : SystÃ¨me complet
  âœ“ Modal carte : Seuils 50/100000
  âœ“ Bordereaux : Nom + adresse banque


================================================================================

ðŸ†˜ EN CAS DE PROBLÃˆME
================================================================================

Rollback automatique (dÃ©jÃ  fait si erreur pendant deploy.sh)

Rollback manuel :
-----------------
git reset --hard <commit-precedent>
npm install
npx prisma generate
NODE_ENV=production npm run build
pm2 restart stock-management

Restaurer les donnÃ©es (si vraiment nÃ©cessaire) :
-------------------------------------------------
pm2 stop stock-management
psql -U postgres stock_management < backup_securite_20251020_xxx.sql
pm2 start stock-management


================================================================================

ðŸ“š DOCUMENTATION COMPLÃˆTE
================================================================================

cat ETAPES-DEPLOY-REDHAT.md          # Guide Ã©tape par Ã©tape dÃ©taillÃ©
cat DEPLOY-WITH-EXISTING-DATA.md     # Protection donnÃ©es existantes
cat DEPLOY-NOW.md                    # Guide rapide
cat ROLLBACK-GUIDE.md                # Guide rollback


================================================================================

